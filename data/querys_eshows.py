from data.dbconnect import get_dataframe_from_query
import streamlit as st

#Media de candidatos por oportunidade Mensal
@st.cache_data
def avarege_candidates_by_opportunity_month(day1_atual, day2_atual, day1_anterior, day2_anterior):
    return get_dataframe_from_query(f"""
SELECT 
	DATE_FORMAT(O.DATA_INICIO, '%m/%Y') AS 'Data',
	COUNT(C.ID) AS 'Total de Candidaturas',
	COUNT(DISTINCT O.ID) AS 'Total de Oportunidades',
	ROUND(COUNT(C.ID) / COUNT(DISTINCT O.ID), 2) AS 'Media por Vaga',
  
  (SELECT
   COUNT(C.ID) AS 'Total de Candidaturas'
   FROM T_OPORTUNIDADES O
   LEFT JOIN T_CANDIDATOS C ON C.FK_OPORTUNIDADE = O.ID
		WHERE O.DATA_INICIO >= '{day1_atual}'
   	AND O.DATA_INICIO < '{day2_atual}'
		AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
	) AS 'Candidaturas Do Período Atual',
  
  (SELECT
   COUNT(C.ID) AS 'Total de Candidaturas'
   FROM T_OPORTUNIDADES O
   LEFT JOIN T_CANDIDATOS C ON C.FK_OPORTUNIDADE = O.ID
		WHERE O.DATA_INICIO >= '{day1_anterior}'
   	AND O.DATA_INICIO < '{day2_anterior}'
		AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
	) AS 'Candidaturas Do Período Anterior'
  
FROM T_OPORTUNIDADES O
LEFT JOIN T_CANDIDATOS C ON C.FK_OPORTUNIDADE = O.ID
	WHERE O.DATA_INICIO IS NOT NULL
	AND O.DATA_INICIO >= '2024-01-01'
	AND O.DATA_INICIO <= LAST_DAY(NOW())
	AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624','343')
GROUP BY DATE_FORMAT(O.DATA_INICIO, '%m/%Y')
ORDER BY YEAR(O.DATA_INICIO), MONTH(O.DATA_INICIO)
""")

#Media de candidatos por oportunidade Semanal
@st.cache_data
def avarege_candidates_by_opportunity_week():
    return get_dataframe_from_query("""
SELECT 
	CONCAT(
    LPAD(WEEK(O.DATA_INICIO, 1) - WEEK(DATE_SUB(O.DATA_INICIO, INTERVAL DAY(O.DATA_INICIO) - 1 DAY), 1) + 1, 2, '0'),'/', LPAD(MONTH(O.DATA_INICIO), 2, '0'), '/', YEAR(O.DATA_INICIO)) AS 'Semana/Mês/Ano',
	COUNT(C.ID) AS 'Total de Candidaturas',
	COUNT(DISTINCT O.ID) AS 'Total de Oportunidades',
	ROUND(COUNT(C.ID) / COUNT(DISTINCT O.ID), 2) AS 'Media por Vaga'
FROM T_OPORTUNIDADES O
LEFT JOIN T_CANDIDATOS C ON C.FK_OPORTUNIDADE = O.ID
	WHERE O.DATA_INICIO IS NOT NULL
	AND O.DATA_INICIO >= '2025-01-01'
	AND O.DATA_INICIO < DATE_FORMAT(NOW(), '%Y-%m-01')    
	AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
GROUP BY 
  YEAR(O.DATA_INICIO),
  MONTH(O.DATA_INICIO),
  WEEK(O.DATA_INICIO, 1) - WEEK(DATE_SUB(O.DATA_INICIO, INTERVAL DAY(O.DATA_INICIO) - 1 DAY), 1) + 1

ORDER BY 
  YEAR(O.DATA_INICIO),
  MONTH(O.DATA_INICIO),
  WEEK(O.DATA_INICIO, 1) - WEEK(DATE_SUB(O.DATA_INICIO, INTERVAL DAY(O.DATA_INICIO) - 1 DAY), 1) + 1;;
""")

@st.cache_data
def avarege_candidates_by_artist(day, day2):
    return get_dataframe_from_query(f"""
#Media de candidaturas por artista
SELECT 
	A.ID AS 'ID ARTISTA',
	A.NOME AS 'ARTISTA',

	(SELECT COUNT(*) FROM T_OPORTUNIDADES O
		WHERE O.DATA_INICIO BETWEEN '{day}' AND '{day2}'
		AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
	) AS 'Oportunidades Do Período',
     
  
      (SELECT COUNT(*)
   FROM (
      SELECT A2.ID
      FROM T_ATRACOES A2
      LEFT JOIN T_CANDIDATOS C2 ON C2.FK_ATRACAO = A2.ID
      LEFT JOIN T_OPORTUNIDADES O2 ON O2.ID = C2.FK_OPORTUNIDADE
      WHERE O2.DATA_INICIO BETWEEN '{day}' AND '{day2}'
        AND O2.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
      GROUP BY A2.ID
      HAVING COUNT(C2.ID) > 35
   ) AS artistas_ativos
  ) AS 'Candidatos Ativos',

	COUNT(DISTINCT C.ID) AS 'Candidaturas do Artista',

	ROUND(
  COUNT(DISTINCT C.ID) / NULLIF(TIMESTAMPDIFF(MONTH, '{day}', '{day2}') + 1, 0)
, 2) AS 'Média de Candidaturas por Mês',

	COUNT(CASE WHEN C.FK_STATUS_CANDIDATO = '100' THEN 1 END) AS 'Aceite Total',
     
    (
  SELECT COUNT(DISTINCT P2.ID)
  FROM T_OPORTUNIDADES O
  LEFT JOIN T_PROPOSTAS P2 ON P2.FK_OPORTUNIDADE = O.ID
  LEFT JOIN T_CANDIDATOS C2 ON C2.FK_OPORTUNIDADE = O.ID
  WHERE P2.FK_CONTRATADO = A.ID
    AND P2.FK_STATUS_PROPOSTA IN ('101','103','104')
    AND C2.FK_STATUS_CANDIDATO = '100'
    AND O.DATA_INICIO BETWEEN '2025-08-20' AND '2025-09-20'
    AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
) AS 'Shows que Aconteceram',

	ROUND(
  COUNT(CASE WHEN C.FK_STATUS_CANDIDATO = '100' THEN 1 END) / NULLIF(TIMESTAMPDIFF(MONTH, '{day}', '{day2}') + 1, 0)
, 2) AS 'Média Aceite por Mês'

FROM T_ATRACOES A
LEFT JOIN T_CANDIDATOS C ON C.FK_ATRACAO = A.ID
LEFT JOIN T_OPORTUNIDADES O ON O.ID = C.FK_OPORTUNIDADE

WHERE O.DATA_INICIO BETWEEN '{day}' AND '{day2}'
  AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')

GROUP BY A.ID, A.NOME
ORDER BY COUNT(DISTINCT C.ID) DESC;
""")

@st.cache_data
def avarege_opportunity_created_month():
    return get_dataframe_from_query("""
SELECT
DATE_FORMAT(O.DATA_INICIO, '%m/%Y') AS 'Mes/Ano',
COUNT(DISTINCT O.ID) AS 'Oportunidades',
ROUND(AVG(TIMESTAMPDIFF(DAY, ZO.LOG_DATE, O.DATA_INICIO)), 2) AS 'Media em DIAS',
ROUND(AVG(TIMESTAMPDIFF(HOUR, ZO.LOG_DATE, O.DATA_INICIO)), 2) AS 'Media em Horas',
ROUND(AVG(TIMESTAMPDIFF(MINUTE, ZO.LOG_DATE, O.DATA_INICIO)), 2) AS 'Media em Minutos',
ROUND(AVG(CAN.CANDIDATURA), 2) AS 'Media até Candidatura H',
ROUND(AVG(CAND_PROPOS.HORAS_CAND_PROPOS), 2) AS 'Media até Aceite D'

FROM T_OPORTUNIDADES O
LEFT JOIN ZLOG_T_OPORTUNIDADES ZO ON ZO.ID = O.ID

LEFT JOIN (
  SELECT
  O2.ID AS O_ID,
  TIMESTAMPDIFF(HOUR, O2.CREATED_AT, MIN(C2.CREATED_AT)) AS CANDIDATURA
  FROM T_OPORTUNIDADES O2
  LEFT JOIN T_CANDIDATOS C2 ON C2.FK_OPORTUNIDADE = O2.ID
  GROUP BY O2.ID
  ) CAN ON CAN.O_ID = O.ID

LEFT JOIN (
  SELECT
  O3.ID AS O_ID,
  TIMESTAMPDIFF(DAY, MIN(C3.CREATED_AT), P3.CREATED_AT) AS HORAS_CAND_PROPOS
  FROM T_OPORTUNIDADES O3
  JOIN T_CANDIDATOS C3 ON C3.FK_OPORTUNIDADE = O3.ID AND C3.FK_STATUS_CANDIDATO = '100'
  LEFT JOIN T_PROPOSTAS P3 ON P3.FK_OPORTUNIDADE = O3.ID
  WHERE O3.DATA_INICIO >= '2024-01-01'
  AND O3.DATA_INICIO <= LAST_DAY(NOW())
  AND O3.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
  GROUP BY O3.ID, P3.CREATED_AT
  ) CAND_PROPOS ON CAND_PROPOS.O_ID = O.ID
  
WHERE ZO.DATA_INICIO >= '2024-01-01'
  AND ZO.DATA_INICIO <= LAST_DAY(NOW())
  AND O.DATA_INICIO >= '2024-01-01'
  AND O.DATA_INICIO <= LAST_DAY(NOW())
  AND ZO.LOG_DATE IS NOT NULL
  AND ZO.DATA_INICIO IS NOT NULL
  AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624','343')
GROUP BY DATE_FORMAT(O.DATA_INICIO, '%m/%Y');
""")


@st.cache_data
def avarege_opportunity_created_year():
    return get_dataframe_from_query("""
SELECT DISTINCT
	YEAR(O.DATA_INICIO) AS 'Ano',
	COUNT(DISTINCT DATE_FORMAT(O.DATA_INICIO, '%Y-%m')) AS 'Meses no Ano',
	COUNT(DISTINCT O.ID) AS 'Oportunidades',
 	ROUND(AVG(TIMESTAMPDIFF(DAY, ZO.LOG_DATE, O.DATA_INICIO)), 2) AS 'Media em DIAS',
 	ROUND(AVG(TIMESTAMPDIFF(HOUR, ZO.LOG_DATE, O.DATA_INICIO)), 2) AS 'Media em Horas',  
	ROUND(AVG(TIMESTAMPDIFF(MINUTE, ZO.LOG_DATE, O.DATA_INICIO)), 2) AS 'Media em Minutos'
FROM T_OPORTUNIDADES O
LEFT JOIN ZLOG_T_OPORTUNIDADES ZO ON ZO.ID = O.ID
 	WHERE ZO.DATA_INICIO >= '2024-01-01'
 	AND ZO.DATA_INICIO <= DATE_FORMAT(NOW(), '%Y-%m-01') 
  AND O.DATA_INICIO >= '2024-01-01'
	AND O.DATA_INICIO <= DATE_FORMAT(NOW(), '%Y-%m-01')
 	AND ZO.LOG_DATE IS NOT NULL
 	AND ZO.DATA_INICIO IS NOT NULL
	AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624','343')
GROUP BY YEAR(O.DATA_INICIO)
ORDER BY YEAR(O.DATA_INICIO);
""")

#Valor liquido por formação
@st.cache_data
def liquid_value_per_training(date):
	return get_dataframe_from_query(f"""
SELECT 
  F.DESCRICAO AS 'FORMAÇÃO',
  COUNT(O.ID) AS 'OPORTUNIDADES',
  F.NUM_INTEGRANTES AS 'INTEGRANTES',
  ROUND(SUM(O.VALOR_LIQUIDO) / COUNT(O.ID), 2) AS 'MEDIA POR FORMACAO',
  ROUND(AVG(TIMESTAMPDIFF(HOUR, O.DATA_INICIO, O.DATA_FIM)), 2) AS 'Media de horas por show',
  ROUND(
    (SUM(O.VALOR_LIQUIDO) / COUNT(O.ID)) / AVG(TIMESTAMPDIFF(HOUR, O.DATA_INICIO, O.DATA_FIM))
  , 4) AS 'Valor por H'
FROM T_OPORTUNIDADES O
LEFT JOIN T_FORMACAO F ON F.ID = O.FK_FORMACAO
WHERE F.ID IS NOT NULL
  AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
  AND O.DATA_INICIO LIKE '{date}-%'
  AND O.DATA_INICIO < O.DATA_FIM
GROUP BY O.FK_FORMACAO, F.DESCRICAO, F.NUM_INTEGRANTES
ORDER BY O.FK_FORMACAO;
""")

@st.cache_data
def liquid_valuer_per_style(date):
	return get_dataframe_from_query(f"""
WITH ESTILOS AS (
    SELECT 
        O.ID,
        O.VALOR_LIQUIDO,
        EM.DESCRICAO
    FROM T_OPORTUNIDADES O
    LEFT JOIN T_PROPOSTAS P ON P.ID = O.FK_PROPOSTA
    LEFT JOIN T_ATRACOES A ON A.ID = P.FK_CONTRATADO
    LEFT JOIN T_ESTILOS_MUSICAIS EM ON EM.ID = O.FK_ESTILO_INTERESSE_1
    WHERE O.DATA_INICIO LIKE '{date}-%'
      AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
      AND A.NOME NOT LIKE '%Teste%'
      AND O.FK_STATUS_OPORTUNIDADE IN ('102','103','104')

    UNION ALL

    SELECT 
        O.ID,
        O.VALOR_LIQUIDO,
        EM2.DESCRICAO
    FROM T_OPORTUNIDADES O
    LEFT JOIN T_PROPOSTAS P ON P.ID = O.FK_PROPOSTA
    LEFT JOIN T_ATRACOES A ON A.ID = P.FK_CONTRATADO
    LEFT JOIN T_ESTILOS_MUSICAIS EM2 ON EM2.ID = O.FK_ESTILO_INTERESSE_2
    WHERE O.DATA_INICIO LIKE '{date}-%'
      AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
      AND A.NOME NOT LIKE '%Teste%'
      AND O.FK_STATUS_OPORTUNIDADE IN ('102','103','104')

    UNION ALL

    SELECT 
        O.ID,
        O.VALOR_LIQUIDO,
        EM3.DESCRICAO
    FROM T_OPORTUNIDADES O
    LEFT JOIN T_PROPOSTAS P ON P.ID = O.FK_PROPOSTA
    LEFT JOIN T_ATRACOES A ON A.ID = P.FK_CONTRATADO
    LEFT JOIN T_ESTILOS_MUSICAIS EM3 ON EM3.ID = O.FK_ESTILO_INTERESSE_3
    WHERE O.DATA_INICIO LIKE '{date}-%'
      AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')
      AND A.NOME NOT LIKE '%Teste%'
      AND O.FK_STATUS_OPORTUNIDADE IN ('102','103','104')
),

ESTILOS_DUPLICADOS AS (
    SELECT DISTINCT ID, DESCRICAO, VALOR_LIQUIDO
    FROM ESTILOS
)

SELECT 
    DESCRICAO AS 'Estilo',
    COUNT(*) AS 'Oportunidades',
    ROUND(SUM(VALOR_LIQUIDO), 2) AS 'Valor Total',
    ROUND(AVG(VALOR_LIQUIDO), 2) AS 'Media por Show'
FROM ESTILOS_DUPLICADOS
WHERE DESCRICAO IS NOT NULL
GROUP BY DESCRICAO
ORDER BY COUNT(*) DESC;
""")

@st.cache_data
def recused_opportunities():
    return get_dataframe_from_query(f"""
SELECT
DATE_FORMAT(O.DATA_INICIO, '%m/%Y') AS 'Mes/Ano',
COUNT(P.ID) AS 'QUANTIDADE RECUSA'

FROM T_PROPOSTAS P
INNER JOIN T_OPORTUNIDADES O ON O.FK_PROPOSTA = P.ID OR P.FK_OPORTUNIDADE = O.ID
LEFT JOIN T_MOTIVO_RECUSA_PROPOSTA RP ON RP.FK_PROPOSTA = P.ID

WHERE P.DATA_INICIO > '2024-01-01'
AND P.DATA_INICIO <= LAST_DAY(NOW())
AND P.FK_STATUS_PROPOSTA = '102'
AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')

GROUP BY DATE_FORMAT(O.DATA_INICIO, '%m/%Y')
ORDER BY YEAR(O.DATA_INICIO), MONTH(O.DATA_INICIO);
                                    
""")

@st.cache_data
def canceled_opportunities():
    return get_dataframe_from_query(f"""
SELECT
DATE_FORMAT(O.DATA_INICIO, '%m/%Y') AS 'Mes/Ano',
MCO.TEXTO_MOTIVO AS 'MOTIVO',
COUNT(O.ID) AS 'CANCELAMENTOS'

FROM T_OPORTUNIDADES O
LEFT JOIN T_MOTIVO_CANCELAMENTO_OPORTUNIDADE MCO ON MCO.ID = O.FK_MOTIVO_CANCELAMENTO
WHERE O.FK_MOTIVO_CANCELAMENTO IS NOT NULL
AND O.DATA_INICIO > '2024-01-01'
AND O.DATA_INICIO <= LAST_DAY(NOW())
AND O.FK_CONTRATANTE NOT IN ('102','196','1015','1861','1871','1982','1983','1985','2624')

GROUP BY O.FK_MOTIVO_CANCELAMENTO, DATE_FORMAT(O.DATA_INICIO, '%m/%Y')
ORDER BY YEAR(O.DATA_INICIO), MONTH(O.DATA_INICIO), O.FK_MOTIVO_CANCELAMENTO
""")